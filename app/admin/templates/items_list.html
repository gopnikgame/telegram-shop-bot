{% extends "base.html" %}
{% block content %}
<div class="card">
  <div class="row" style="justify-content:space-between; align-items:center;">
    <h3 style="margin:0;">–¢–æ–≤–∞—Ä—ã</h3>
    <div class="row" style="gap:8px;">
      <a class="btn btn-primary" href="/admin/items/new" title="–î–æ–±–∞–≤–∏—Ç—å">–î–æ–±–∞–≤–∏—Ç—å</a>
      <a class="btn" href="/admin/items/backup" title="–°–∫–∞—á–∞—Ç—å –±–µ–∫–∞–ø">‚¨áÔ∏è –ë–µ–∫–∞–ø</a>
      <form method="post" action="/admin/items/restore" enctype="multipart/form-data" class="row" style="gap:8px;">
        <input type="file" name="file" accept=".zip" />
        <button class="btn" title="–ó–∞–≥—Ä—É–∑–∏—Ç—å –±–µ–∫–∞–ø">‚¨ÜÔ∏è –í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å</button>
      </form>
    </div>
  </div>
  {% if error %}
    <div class="row" style="margin-top:12px; color:#fca5a5;">{{ error }}</div>
  {% endif %}
  <table style="margin-top:16px;">
    <thead>
      <tr>
        <th>ID</th>
        <th>–ù–∞–∑–≤–∞–Ω–∏–µ</th>
        <th>–¢–∏–ø</th>
        <th>–¶–µ–Ω–∞</th>
        <th>–û—Å—Ç–∞—Ç–æ–∫</th>
        <th style="width:460px; text-align:right;">–î–µ–π—Å—Ç–≤–∏—è</th>
      </tr>
    </thead>
    <tbody>
      {% for i in items %}
      <tr>
        <td>{{ i.id }}</td>
        <td>{{ i.title }}</td>
        <td>{{ i.item_type.value }}</td>
        <td>{{ '%.2f' % (i.price_minor/100) }} ‚ÇΩ</td>
        <td>
          {% if i.item_type.value == 'digital' %}
            {{ i.codes_left if i.codes_left is defined else '-' }}
          {% else %}
            ‚Äî
          {% endif %}
        </td>
        <td style="text-align:right;">
          <div class="row" style="justify-content:flex-end; gap:8px; flex-wrap:wrap;">
            <a class="btn btn-icon" href="/admin/items/{{ i.id }}" title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å">‚úèÔ∏è</a>
            <form method="post" action="/admin/items/{{ i.id }}/delete" style="display:inline;">
              <button type="submit" class="btn btn-danger btn-icon" title="–£–¥–∞–ª–∏—Ç—å" onclick="return confirm('–£–¥–∞–ª–∏—Ç—å —Ç–æ–≤–∞—Ä?');">üóëÔ∏è</button>
            </form>
            <form method="post" action="/admin/items/{{ i.id }}/toggle_visibility" style="display:inline;">
              {% if i.is_visible %}
                <button type="submit" class="btn btn-secondary btn-icon" title="–°–∫—Ä—ã—Ç—å">üôà</button>
              {% else %}
                <button type="submit" class="btn btn-success btn-icon" title="–ü–æ–∫–∞–∑–∞—Ç—å">üëÄ</button>
              {% endif %}
            </form>
            {% if i.item_type.value == 'digital' %}
              <button class="btn btn-icon" title="–î–æ–≥—Ä—É–∑–∏—Ç—å TXT" onclick="openCodesModal({{ i.id }})">‚ûïTXT</button>
            {% endif %}
          </div>
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
  <div class="row" style="justify-content:space-between; margin-top:12px;">
    <div style="color:#9aa4b2; font-size:12px;">–í—Å–µ–≥–æ: {{ total }}</div>
    <div class="row" style="gap:8px;">
      {% set prev = page-1 %}
      {% set next = page+1 %}
      {% if page > 1 %}
        <a class="btn" href="/admin/items?page={{ prev }}">–ù–∞–∑–∞–¥</a>
      {% endif %}
      {% if page*page_size < total %}
        <a class="btn" href="/admin/items?page={{ next }}">–í–ø–µ—Ä—ë–¥</a>
      {% endif %}
    </div>
  </div>
</div>

<!-- –ú–æ–¥–∞–ª–∫–∞ –¥–æ–≥—Ä—É–∑–∫–∏ TXT –∫–æ–¥–æ–≤ -->
<div id="codesModal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.5); align-items:center; justify-content:center;">
  <div style="background:#111827; border:1px solid #1f2937; padding:20px; border-radius:12px; width:420px; box-shadow:0 10px 30px rgba(0,0,0,0.4);">
    <h3>–î–æ–≥—Ä—É–∑–∏—Ç—å TXT –∫ —Ç–æ–≤–∞—Ä—É</h3>
    <p style="color:#9aa4b2; font-size:13px; margin-top:6px;">–ö–∞–∂–¥–∞—è —Å—Ç—Ä–æ–∫–∞ ‚Äî –æ—Ç–¥–µ–ª—å–Ω–∞—è –ø–æ–∑–∏—Ü–∏—è.</p>
    <input id="codesFile" type="file" accept=".txt" style="margin:12px 0; width:100%" />
    <div style="display:flex; gap:8px; justify-content:flex-end; margin-top:8px;">
      <button class="btn btn-secondary" onclick="closeCodesModal()">–û—Ç–º–µ–Ω–∞</button>
      <button class="btn btn-primary" onclick="submitCodes()">–ó–∞–≥—Ä—É–∑–∏—Ç—å</button>
    </div>
    <div id="codesMsg" style="margin-top:10px; font-size:13px;"></div>
  </div>
  <input type="hidden" id="codesItemId" />
  
</div>

<script>
  function openCodesModal(itemId){
    document.getElementById('codesItemId').value = itemId;
    document.getElementById('codesFile').value = '';
    document.getElementById('codesMsg').textContent = '';
    document.getElementById('codesModal').style.display = 'flex';
  }
  function closeCodesModal(){
    document.getElementById('codesModal').style.display = 'none';
  }
  async function submitCodes(){
    const fileInp = document.getElementById('codesFile');
    const itemId = document.getElementById('codesItemId').value;
    const msg = document.getElementById('codesMsg');
    if(!fileInp.files || fileInp.files.length === 0){
      msg.textContent = '–í—ã–±–µ—Ä–∏—Ç–µ TXT-—Ñ–∞–π–ª.';
      msg.style.color = '#fca5a5';
      return;
    }
    const fd = new FormData();
    fd.append('file', fileInp.files[0]);
    msg.textContent = '–ó–∞–≥—Ä—É–∑–∫–∞...';
    msg.style.color = '#9aa4b2';
    try{
      const resp = await fetch(`/admin/items/${itemId}/add_codes`, { method: 'POST', body: fd });
      const data = await resp.json();
      if(data.ok){
        msg.textContent = `–î–æ–±–∞–≤–ª–µ–Ω–æ: ${data.added}`;
        msg.style.color = '#86efac';
        setTimeout(()=>{ location.reload(); }, 800);
      }else{
        msg.textContent = data.error || '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏.';
        msg.style.color = '#fca5a5';
      }
    }catch(e){
      msg.textContent = '–û—à–∏–±–∫–∞ —Å–µ—Ç–∏.';
      msg.style.color = '#fca5a5';
    }
  }
</script>
{% endblock %}
