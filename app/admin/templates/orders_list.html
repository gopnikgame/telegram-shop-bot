{% extends "base.html" %}
{% block content %}
<div class="card">
  <div class="row" style="justify-content:space-between; align-items:center;">
    <h3 style="margin:0;">–ó–∞–∫–∞–∑—ã</h3>
    <form method="get" class="row" style="gap:8px;">
      <input type="text" name="q" value="{{ query or '' }}" placeholder="–ü–æ–∏—Å–∫ –ø–æ TG ID" style="width:220px;" />
      <button class="btn">–ò—Å–∫–∞—Ç—å</button>
    </form>
  </div>
  <form method="post" action="/admin/orders/delete" class="row" style="gap:8px; margin-top:8px;">
    <input type="number" name="order_id" placeholder="ID –∑–∞–∫–∞–∑–∞" style="width:160px;" required />
    <button class="btn btn-danger" onclick="return confirm('–£–¥–∞–ª–∏—Ç—å –∑–∞–∫–∞–∑?');">–£–¥–∞–ª–∏—Ç—å –ø–æ ID</button>
  </form>
  <table style="margin-top:16px;">
    <thead>
      <tr>
        <th>ID</th>
        <th>–¢–æ–≤–∞—Ä</th>
        <th>–°—É–º–º–∞</th>
        <th>–°—Ç–∞—Ç—É—Å</th>
        <th>–ü–æ–∫—É–ø–∞—Ç–µ–ª—å TG</th>
        <th>–î–æ—Å—Ç–∞–≤–∫–∞</th>
        <th style="text-align:right;">–î–µ–π—Å—Ç–≤–∏—è</th>
      </tr>
    </thead>
    <tbody>
      {% for o in orders %}
      <tr>
        <td>{{ o.id }}</td>
        <td>{{ o.item_id or '–ö–æ—Ä–∑–∏–Ω–∞' }}</td>
        <td>{{ '%.2f' % (o.amount_minor/100) }} ‚ÇΩ</td>
        <td>{{ o.status.value if o.status else o.status }}</td>
        <td>{{ o.buyer_tg_id or '' }}</td>
        <td>
          {% if o.has_delivery_info %}
            <button type="button" class="btn btn-icon" onclick="showDeliveryInfo({{ o.id }})" title="–ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –¥–∞–Ω–Ω—ã–µ">üì¶</button>
          {% else %}
            ‚Äî
          {% endif %}
        </td>
        <td style="text-align:right;">
          <form method="post" action="/admin/orders/{{ o.id }}/delete" style="display:inline;">
            <button type="submit" class="btn btn-danger btn-icon" title="–£–¥–∞–ª–∏—Ç—å" onclick="return confirm('–£–¥–∞–ª–∏—Ç—å –∑–∞–∫–∞–∑ #{{ o.id }}?');">üóëÔ∏è</button>
          </form>
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
  <div class="row" style="justify-content:space-between; margin-top:12px;">
    <div style="color:#9aa4b2; font-size:12px;">–í—Å–µ–≥–æ: {{ total }}</div>
    <div class="row" style="gap:8px;">
      {% set prev = page-1 %}
      {% set next = page+1 %}
      {% if page > 1 %}
        <a class="btn" href="/admin/orders?page={{ prev }}{% if query %}&q={{ query }}{% endif %}">–ù–∞–∑–∞–¥</a>
      {% endif %}
      {% if page*page_size < total %}
        <a class="btn" href="/admin/orders?page={{ next }}{% if query %}&q={{ query }}{% endif %}">–í–ø–µ—Ä—ë–¥</a>
      {% endif %}
    </div>
  </div>
</div>

<!-- –ú–æ–¥–∞–ª–∫–∞ —Å –¥–∞–Ω–Ω—ã–º–∏ –¥–æ—Å—Ç–∞–≤–∫–∏ -->
<div id="deliveryModal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.5); align-items:center; justify-content:center; z-index:1000;">
  <div style="background:#111827; border:1px solid #1f2937; padding:20px; border-radius:12px; width:520px; box-shadow:0 10px 30px rgba(0,0,0,0.4);">
    <h3>–î–∞–Ω–Ω—ã–µ –¥–æ—Å—Ç–∞–≤–∫–∏ –¥–ª—è –∑–∞–∫–∞–∑–∞ #<span id="deliveryOrderId"></span></h3>
    <div id="deliveryContent" style="margin-top:16px; color:#d1d5db; line-height:1.8;"></div>
    <div style="display:flex; gap:8px; justify-content:flex-end; margin-top:16px;">
      <button class="btn btn-primary" onclick="closeDeliveryModal()">–ó–∞–∫—Ä—ã—Ç—å</button>
    </div>
  </div>
</div>

<script>
async function showDeliveryInfo(orderId) {
  document.getElementById('deliveryOrderId').textContent = orderId;
  const content = document.getElementById('deliveryContent');
  content.innerHTML = '–ó–∞–≥—Ä—É–∑–∫–∞...';
  document.getElementById('deliveryModal').style.display = 'flex';
  
  try {
    const resp = await fetch(`/admin/orders/${orderId}/delivery`);
    const data = await resp.json();
    
    if (data.ok) {
      let html = '<div style="display:grid; gap:12px;">';
      
      if (data.delivery.fullname) {
        html += `<div><strong>üë§ –§–ò–û:</strong> ${data.delivery.fullname}</div>`;
      }
      if (data.delivery.phone) {
        html += `<div><strong>üìû –¢–µ–ª–µ—Ñ–æ–Ω:</strong> ${data.delivery.phone}</div>`;
      }
      if (data.delivery.address) {
        html += `<div><strong>üìç –ê–¥—Ä–µ—Å:</strong> ${data.delivery.address}</div>`;
      }
      if (data.delivery.comment) {
        html += `<div><strong>üí¨ –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π:</strong> ${data.delivery.comment}</div>`;
      }
      
      html += '</div>';
      content.innerHTML = html;
    } else {
      content.innerHTML = '‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö';
    }
  } catch (e) {
    content.innerHTML = '‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ç–∏';
  }
}

function closeDeliveryModal() {
  document.getElementById('deliveryModal').style.display = 'none';
}
</script>
{% endblock %}
